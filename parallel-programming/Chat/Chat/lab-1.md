## Лабораторная работа №1
### Семафор для синхронизации доступа к файлу

**Дисциплина:** Теория параллельного программирования

**Выполнил(и):**
- Алешин Иван Кириллович

**Группа:** ПИН-31

**Дата:** 26.01.2026

**Подпись**:

---

## Аннотация

Программа реализует синхронизацию доступа к файлу с помощью семафора на основе файла Semaphore.txt. Используется технология C# и WinForms. Задача — обеспечить корректный параллельный доступ к ресурсу между двумя окнами приложения.

---

## Содержание

1. [[#1. Назначение и условия применения|Назначение и условия применения]]
2. [[#2. Характеристика программы|Характеристика программы]]
3. [[#3. Описание алгоритма|Описание алгоритма]]
4. [[#4. Используемые технологии программирования|Используемые технологии программирования]]
5. [[#5. Входные и выходные данные|Входные и выходные данные]]
6. [[#6. Результаты тестирования|Результаты тестирования]]

---

## 1. Назначение и условия применения

### 1.1 Назначение программы

Программа предназначена для демонстрации работы семафора при параллельном доступе к файлу. Решает задачу синхронизации между двумя окнами (процессами).

### 1.2 Функции, выполняемые программой

- Синхронизация доступа к файлу через семафор
- Чтение и запись данных в файл
- Демонстрация параллельной работы двух окон

### 1.3 Условия, необходимые для выполнения программы

**Требования к аппаратному обеспечению:**
- Процессор: Ryzen 4500U
- Оперативная память: DDR4 16 Gb 2666MHZ

**Требования к программному обеспечению:**
- Операционная система: Windows 11
- Компилятор: dotnet 8.0
- Библиотеки: стандартные библиотеки .NET

**Требования к персоналу:**
- Базовые знания C# и работы с WinForms

---

## 2. Характеристика программы

### 2.1 Режим работы

Интерактивный, многопоточный (через два окна приложения).

### 2.2 Средства контроля правильности

Корректность работы проверяется отсутствием одновременного доступа к файлу Semaphore.txt и корректным отображением данных в окнах.

---

## 3. Описание алгоритма

### 3.1 Общая схема алгоритма

Каждое окно при запуске пытается получить доступ к файлу Semaphore.txt. Если файл занят, окно ожидает освобождения ресурса. После получения доступа окно может читать/записывать данные.

### 3.2 Последовательная реализация

В последовательной реализации доступ к файлу осуществляется без проверки занятости, что может привести к ошибкам при параллельном запуске.

### 3.3 Параллельная реализация

В параллельной реализации используется следующий фрагмент кода (логика ожидания семафора):

```
SemAvail = false;
while (!SemAvail)
{
    try
    {
        fSemR = File.OpenRead("Semaphore.txt");
        fSemR.Read(bSem, 0, 1);
        fSemR.Close();
        SemAvail = true;
    }
    catch (IOException ex)
    {
        res = ex.ToString();
    }   
}
```

Важно: в реальной реализации проекта (файл `ChatC.cs`) код использует явный путь к семафору в каталоге запуска приложения:

- `semPath = Path.Combine(AppDomain.CurrentDomain.BaseDirectory, "Semaphore.txt")`
- При чтении используется `File.Open(semPath, FileMode.Open, FileAccess.Read, FileShare.ReadWrite)` — это позволяет читать файл даже если другой процесс держит его для чтения/записи.
- Если файл не найден (`FileNotFoundException`), программа создаёт его и записывает символ `'0'` — это означает, что семафор свободен.
- При записи семафора (в методе `Save`) используется `File.Open(semPath, FileMode.Create, FileAccess.Write, FileShare.None)` — запись выполняется с эксклюзивным доступом (блокирует других читателей), и в файл записывается `'1'` (заблокировано).

Поведение для читателя/запуска:
- Если при чтении обнаружено значение `'0'`, таймер `tmrSem` активируется для периодической проверки (polling).
- Если при чтении значение отличное от `'0'`, код пытается сбросить семафор в `'0'` (записывает с эксклюзивным доступом) и загрузить содержимое `Grasshopper.rtf` в `RichTextBox`.

### 3.4 Взаимодействие с пользовательским интерфейсом (реализация)

- Форма `ChatF` содержит две кнопки: `Load` (вызов `ChC.Load(rtbChat, tmrSem)`) и `Save` (вызов `ChC.Save(rtbChat)`).
- Таймер `tmrSem` по событию `Tick` также вызывает `ChC.Load`, что обеспечивает проверку семафора по таймеру.
- Таким образом, при нажатии `Save` семафор устанавливается в `'1'`, а при вызове `Load` другой экземпляр приложения или окно дождётся освобождения семафора и загрузит файл.

---

## 4. Используемые технологии программирования

### 4.1 Язык программирования

C#

### 4.2 Фреймворки и библиотеки

- .NET 8.0
- WinForms

### 4.3 Используемые объекты и структуры данных

- Класс File
- Массив байт bSem
- Переменная SemAvail

### 4.4 Особенности реализации

Семафор реализован через файл `Semaphore.txt` в каталоге исполнения приложения (`AppDomain.CurrentDomain.BaseDirectory`). Реализация учитывает следующие моменты:
- Создание файла семафора при его отсутствии с начальным значением `'0'`.
- Явное использование параметров `FileShare` при чтении и записи для контроля конкурентного доступа.
- Обработка исключений `FileNotFoundException` и `IOException` с кратковременной задержкой/повтором для устойчивости.

---

## 5. Входные и выходные данные

### 5.1 Входные данные

**Формат:**
Файл Semaphore.txt, управляющий доступом к ресурсу.

**Пример:**
```
0
```

### 5.2 Выходные данные

**Формат:**
Изменённое содержимое файла Semaphore.txt и отображение данных в окне.

**Пример:**
```
1
```

### 5.3 Запуск программы

Для сборки и запуска проекта в среде с установленным .NET SDK 8.x можно выполнить (в PowerShell):

```powershell
# Перейти в каталог проекта (где расположен Chat.csproj)
Set-Location -Path 'C:\Dev\Workspace\Chat\Chat'

# Сборка (Debug):
& 'C:\Program Files\dotnet\dotnet.exe' build -c Debug

# Запуск (вариант 1) — запуск сборки через dotnet (DLL):
& 'C:\Program Files\dotnet\dotnet.exe' 'C:\Dev\Workspace\Chat\Chat\bin\Debug\net8.0-windows\Chat.dll'

# Или просто запустить .exe файл из /bin:
& 'C:\Dev\Workspace\Chat\Chat\bin\Debug\net8.0-windows\Chat.exe'
```

Заметки:
- Проект таргетирует `net8.0-windows`; убедитесь, что установлен runtime `Microsoft.NETCore.App` / `Microsoft.WindowsDesktop.App` версии 8.x и что ваш `dotnet` по пути соответствует ожидаемой версии.
- В Rider можно просто нажать кнопку Run/Debug или Build → Build Solution и затем запустить `Chat.exe` из папки `bin`.

---

## 6. Результаты тестирования

### 6.1 Описание тестовых данных

Для тестирования использовались два окна приложения, одновременно обращающиеся к Semaphore.txt.

### 6.2 Функциональное тестирование

**Тест 1:** Одно окно получает доступ к файлу, второе ожидает
- Входные данные: Semaphore.txt = 0
- Ожидаемый результат: Одно окно работает, второе ждёт
- Полученный результат: ✓ Пройден

**Тест 2:** Оба окна поочерёдно получают доступ
- Входные данные: Semaphore.txt = 0
- Ожидаемый результат: Окна поочерёдно получают доступ
- Полученный результат: ✓ Пройден

### 6.3 Тестирование производительности

| Количество окон | Время ожидания | Корректность работы |
| --------------- | -------------- | ------------------- |
| 1               | минимальное    | ✓                   |
| 2               | увеличено      | ✓                   |

**Выводы по результатам тестирования:**

Семафор корректно синхронизирует доступ между окнами, предотвращая одновременное изменение файла.

---
## Список использованных источников

1. Документация Microsoft по File I/O
2. Методические указания по теории параллельного программирования
